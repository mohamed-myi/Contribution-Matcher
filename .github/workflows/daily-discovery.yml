name: Daily Issue Discovery

on:
  schedule:
    # Run daily at 10 AM US Central Time (15:00 UTC = 10 AM CDT, 16:00 UTC = 10 AM CST)
    # Note: Adjust for daylight saving time if needed
    - cron: '0 15 * * *'  # 10 AM CDT (most of the year)
  workflow_dispatch:  # Allow manual triggering

jobs:
  discover-issues:
    runs-on: ubuntu-latest
    timeout-minutes: 45  # Allow time for multi-strategy discovery
    permissions:
      contents: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      # Multi-strategy discovery for variety
      - name: Discover beginner-friendly issues
        timeout-minutes: 10
        env:
          PAT_TOKEN: ${{ secrets.PAT_TOKEN }}
          FAST_DISCOVERY: "true"
          CACHE_VALIDITY_DAYS: "7"
        run: |
          echo "=== Discovering beginner-friendly issues ==="
          python main.py discover --limit 15 --labels "good first issue,beginner-friendly,first-timers-only"
        continue-on-error: true
      
      - name: Discover help wanted issues
        timeout-minutes: 10
        env:
          PAT_TOKEN: ${{ secrets.PAT_TOKEN }}
          FAST_DISCOVERY: "true"
          CACHE_VALIDITY_DAYS: "7"
        run: |
          echo "=== Discovering help wanted issues ==="
          python main.py discover --limit 15 --labels "help wanted,contributions welcome,up-for-grabs"
        continue-on-error: true
      
      - name: Discover Python issues
        timeout-minutes: 10
        env:
          PAT_TOKEN: ${{ secrets.PAT_TOKEN }}
          FAST_DISCOVERY: "true"
          CACHE_VALIDITY_DAYS: "7"
        run: |
          echo "=== Discovering Python issues ==="
          python main.py discover --limit 10 --language python --labels "good first issue"
        continue-on-error: true
      
      - name: Discover JavaScript/TypeScript issues
        timeout-minutes: 10
        env:
          PAT_TOKEN: ${{ secrets.PAT_TOKEN }}
          FAST_DISCOVERY: "true"
          CACHE_VALIDITY_DAYS: "7"
        run: |
          echo "=== Discovering JavaScript/TypeScript issues ==="
          python main.py discover --limit 10 --language javascript --labels "good first issue"
        continue-on-error: true
      
      - name: Clean up stale issues
        timeout-minutes: 5
        env:
          PAT_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          echo "=== Cleaning up stale (closed) issues ==="
          python main.py cleanup-stale --limit 30
        continue-on-error: true
      
      - name: Score issues against profile
        timeout-minutes: 5
        env:
          PAT_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          # Check if profile exists
          if [ -f "dev_profile.json" ]; then
            python main.py score --top 20 --format json > top_matches.json || echo "Scoring completed with warnings"
          else
            echo "No profile found, skipping scoring"
          fi
        continue-on-error: true
      
      - name: Display results
        run: |
          echo "=== Statistics ==="
          python main.py stats
          echo ""
          echo "=== Variety Statistics ==="
          python main.py variety-stats
          if [ -f "top_matches.json" ]; then
            echo "Top matches saved to top_matches.json"
          fi
      
      - name: Commit database changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add contribution_matcher.db
          if [ -f "top_matches.json" ]; then
            git add top_matches.json
          fi
          git diff --staged --quiet || (git commit -m "Update issue database and top matches [skip ci]" && git push)

